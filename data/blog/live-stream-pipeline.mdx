---
title: 直播流链路介绍
date: '2024-04-07'
tags: ['Live Stream']
draft: false
summary: 直播画面是如何从主播传输给观众的？传输延时有多少，画面清晰度又是什么决定的？
---

<TOCInline toc={props.toc} asDisclosure />

### 1. 原理

直播链路通常是从采集端通过`推流协议`将音视频送入服务器/CDN，再在CDN端转码并分发多协议流。一般主播端采用`RTMP`协议推流到直播服务器（或云直播服务），服务器可对流做多码率转码并打包成不同协议格式（如 `FLV`、`HLS`、`HTTP-FLV`、`LLS` 等）供观众拉流观看。

多协议支持确保兼容各种终端：RTMP 和 HLS 可基本覆盖常见客户端，HLS适用于对兼容性要求高的场景（跨平台、CDN分发），RTMP适用于延时要求较低的场景。

CDN分发时，RTMP 流可通过 HTTP-FLV（即 HTTP 传输的 FLV 包）进行二级分发，HLS 流则生成 .m3u8 索引和 TS/CMAF 分片。部分平台还提供低延时 HLS/LL-HLS 或自研 LLS（低延时直播）协议，通过细分切片和专用网络实现秒级或亚秒级延迟。

- **推流端**：主播端（采集/编码）输出 RTMP 等协议流，网络上行影响延迟和稳定性。

- **中间链路**：服务器/转码/CDN 负责分发和协议转换。不同协议处理方式不同：如 HLS 需要定期切片生成索引，产生批量延迟；RTMP 则逐帧分发，延迟较低。

- **消费端**：播放器下载流并解码显示，缓冲区大小和解码延迟决定最终延时。播放器通常会缓存数帧或数秒流以应对网络波动，从而引入额外延迟。

### 2. 延迟组成与 GOP 缓存策略

直播总延迟由三部分构成：***生产端***（采集、编码延时）、***网络/CDN***（传输和切片延时）、***消费端***（缓冲和渲染延时）。

例如，HLS 方式由于要等待完整分片并累积多个索引条目，整体延迟通常在数秒以上；若每片长 5 秒且 M3U8 列表含 6 条条目，至少会造成 30 秒延迟。相比之下，RTMP/HTTP-FLV 采用实时流方式，每帧打包发送，延迟可保持在秒级。

`GOP`值（Group of Pictures）表示关键帧的间隔（即两个关键帧之间的帧数），也就是两个IDR帧之间的距离，一个帧组的最大帧数。

消费端如Flash/HTML5播放时还会设置缓冲时间（如1-2秒），以平滑抖动。为了平衡首帧启动速度和整体延迟，常用GOP缓存策略：

- **上限优先**（低延迟）：不缓存过往I帧，播放器启动时需要等待下一个关键帧才开始解码播放（此时延时最小）。
- **下限优先**（抗抖动）：服务器缓存最新一个完整 GOP，玩家拉流后立即使用缓存的I帧开始播放（秒开），但总延迟增加一个GOP长度。

以 [SRS](https://github.com/ossrs/srs) 为例，其 gop_cache 配置可开关此策略：gop_cache off 实现“上限优先”低延迟播放，gop_cache on 则启用缓存快速启动。根据场景需求，可在极低延迟和快速首屏间切换。例如遇弱网不宜黑屏时可启用缓存，下行稳定时可关闭以压缩延迟。


### 3. 各直播协议原理与场景

- `RTMP`（Real-Time Messaging Protocol）：Adobe/Flash 制定，采用长连接 TCP 传输 FLV 数据包。优点是实时性好（典型延迟1–3秒），几乎所有采集设备和老旧播放器都支持，对防火墙穿透友好（常用80端口）。缺点是需插件或专用播放器（现代浏览器不原生支持 Flash）、TCP 特性可能在弱网时造成累积延迟。适用于互动直播、PC 端直播等对延迟要求较高、兼容性要求一般的场景。

- `LLS`（Low-Latency Streaming）：通常指基于专用 CDN/协议的极低延迟方案，常采用精细分片（CMAF/FLV 结合）和推送技术来实现近乎无延迟。优点是延时几乎达到实时，支持大并发；缺点是厂商专有，需要使用对应 SDK/播放器，且部署成本较高。

- `RTC`（WebRTC）：基于 UDP 的实时通讯协议，采用 SRTP 等传输媒体，交互延时可低于500ms。优点是点对点通信实时性极高（适用于视频会议、互动直播连麦等场景）；缺点是需要复杂的信令和 NAT 穿透，原生不易做大规模广播（需SFU/MCU），兼容性依赖浏览器和硬件。RTC 适合1对1或少人数低延迟场景，不适用于标准CDN分发。

- `HTTP-FLV`：即通过 HTTP 持续请求 FLV 流。原理与 RTMP 相似，将音视频打包为 FLV Tag，通过 HTTP 分包传输。优点包括可以使用标准 HTTP（避免防火墙限制）、支持 HTTPS 加密、良好的移动端兼容性；延迟较RTMP略高但通常也在1-3秒。缺点是仍基于 TCP 连接，观众端需要使用支持 HTTP-FLV 的播放器或 JS 引擎（浏览器不可原生播放）。

- `HLS`（HTTP Live Streaming）：苹果公司提出的基于 HTTP 的分段流媒体协议。服务端将视频切成多个 TS 或 CMAF 分片，并生成 M3U8 索引列表；播放器按列表顺序通过 HTTP 拉取并播放。HLS 优点是完全基于 HTTP，可穿透防火墙、方便通过 CDN 缓存分发、客户端实现简单；缺点是固有的“块传输”延迟，通常需要缓冲多个分片（标准播放时延一般在5–15秒以上），不适合对延迟非常敏感的场景。现有 低延迟HLS (LL-HLS) 通过更短分片和部分加载技术可将延迟降至3–5秒。

|协议|封装格式|传输协议|典型延迟|优点|缺点|
|--------|--------|--------|--------|--------|--------|
|RTMP|FLV|TCP|~1–3秒|延迟低、支持CDN分发、设备兼容性好|需Flash/专用播放器，弱网时TCP积累延迟|
|LLS|CMAF/自定义低延时|TCP/HTTP|毫秒级|极低延迟、端到端同步|厂商专有，需要专用SDK/播放器|
|RTC|RTP/SRTP|UDP|1秒|端到端实时（超低延迟），支持P2P|扩展性差，需信令和NAT穿透，难CDN分发|
|HTTP-FLV|FLV|TCP(HTTP)|~1–3秒|延迟低、HTTP友好(支持80端口/HTTPS)、移动端友好|需专用播放器(浏览器无原生支持)，TCP限制|
HLS|TS 或 CMAF|TCP(HTTP)|多秒至十秒级|完全HTTP，可透过防火墙/CDN分发、兼容性强(尤其iOS/HTML5)|高延迟，实时性差|


### 4. 转码档位策略

- H.265：压缩率更高（同等画质下码率约减半），适用于高分辨率档位。
- H.264：保留给兼容性要求高的设备使用。

对于网络不佳的用户，还常提供`窄带高清`档位，即在保证分辨率的同时进一步压低码率。

以下为常用转码档位关系，具体以厂商实际策略为准：

|档位|分辨率|帧率|参考码率 (H.264 / H.265)|说明|
|--------|--------|--------|--------|--------|
|origin|-|-|-|源流|
|uhd|3840×2160|60fps|~6Mbps / 3Mbps|蓝光4K|
|hd|1920×1080|45fps|~4Mbps / 2Mbps|超清1080P|
|zuhd|1920×1080|45fps|~2Mbps / 1Mbps|低码率超清（窄带高清）|
|sd|1280×720|30fps|~2Mbps / 1Mbps|高清720P|
|ld|960x540|25fps|~1Mbps / 500kbps|标清540P|
