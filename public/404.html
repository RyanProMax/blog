<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Loading...</title>
  <script>
    (function() {
      const supportedLanguages = ['en', 'zh'];
      const defaultLocale = 'en';
      const pathname = window.location.pathname;
      const search = window.location.search;
      
      console.log('GitHub Pages Route Handler:', { pathname, search });
      
      // è§£æå½“å‰è·¯å¾„ä¸­çš„è¯­è¨€ä¿¡æ¯ï¼ˆå‚è€ƒmiddlewareé€»è¾‘ï¼‰
      const localeRegex = new RegExp(`^/(${supportedLanguages.join('|')})(/.*)?$`);
      const localeMatch = pathname.match(localeRegex);
      const currentUrlLocale = localeMatch?.[1] || null;
      const basePath = localeMatch?.[2] || '/';
      
      // è·å–ç”¨æˆ·åå¥½è¯­è¨€ï¼ˆå‚è€ƒmiddlewareçš„getPreferredLocaleï¼‰
      function getPreferredLocale() {
        // 1. æ£€æŸ¥localStorageä¸­çš„åå¥½è¯­è¨€
        try {
          const savedLocale = localStorage.getItem('preferred-locale');
          if (savedLocale && supportedLanguages.includes(savedLocale)) {
            console.log('Found locale from localStorage:', savedLocale);
            return savedLocale;
          }
        } catch (e) {
          console.error('localStorage error:', e);
        }
        
        // 2. æ£€æŸ¥æµè§ˆå™¨è¯­è¨€
        const browserLang = navigator.language || navigator.languages?.[0];
        if (browserLang && browserLang.includes('zh')) {
          console.log('Found locale from browser language: zh');
          return 'zh';
        }
        
        // 3. è¿”å›é»˜è®¤è¯­è¨€
        console.log('Using default locale:', defaultLocale);
        return defaultLocale;
      }
      
      const preferredLocale = getPreferredLocale();
      
      // æƒ…å†µ1ï¼šæ ¹è·¯å¾„æˆ–æ— è¯­è¨€å‰ç¼€ -> é‡å®šå‘åˆ°åå¥½è¯­è¨€
      if (pathname === '/' || !currentUrlLocale) {
        const targetPath = `/${preferredLocale}${pathname === '/' ? '' : pathname}${search}`;
        console.log('Adding locale prefix, redirecting to:', targetPath);
        window.location.replace(targetPath);
        return;
      }
      
      // æƒ…å†µ2ï¼šå½“å‰è¯­è¨€ä¸åå¥½è¯­è¨€ä¸åŒ¹é… -> é‡å®šå‘åˆ°åå¥½è¯­è¨€
      if (currentUrlLocale !== preferredLocale) {
        const targetPath = `/${preferredLocale}${basePath}${search}`;
        console.log('Language mismatch, redirecting to:', targetPath);
        window.location.replace(targetPath);
        return;
      }
      
      // æƒ…å†µ3ï¼šè·¯å¾„æœ«å°¾æœ‰æ–œæ ä½†ä¸æ˜¯æ ¹è·¯å¾„ -> å»æ‰æ–œæ é‡å®šå‘
      // ç‰¹æ®Šå¤„ç†ï¼š/zh/ -> /zh, /en/ -> /en
      if (pathname.endsWith('/') && pathname !== '/') {
        const targetPath = pathname.slice(0, -1) + search;
        console.log('Removing trailing slash, redirecting to:', targetPath);
        window.location.replace(targetPath);
        return;
      }
      
      // æƒ…å†µ4ï¼šé¡µé¢ç¡®å®ä¸å­˜åœ¨ -> é‡å®šå‘åˆ°è¯¥è¯­è¨€çš„é¦–é¡µ
      if (basePath !== '/') {
        const targetPath = `/${currentUrlLocale}/${search}`;
        console.log('Page not found, redirecting to locale home:', targetPath);
        window.location.replace(targetPath);
      }
    })();
  </script>
</head>
<body>
  <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: system-ui;">
    <div style="text-align: center;">
      <div style="margin-bottom: 16px;">ğŸ”„</div>
      <div>Loading...</div>
    </div>
  </div>
</body>
</html> 
