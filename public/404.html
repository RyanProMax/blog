<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Loading...</title>
  <script>
    (function() {
      const supportedLanguages = ['en', 'zh'];
      const defaultLocale = 'en';
      const pathname = window.location.pathname;
      const search = window.location.search;
      const urlParams = new URLSearchParams(search);
      
      console.log('GitHub Pages Route Handler:', { pathname, search });
      
      // æ£€æŸ¥è·¯å¾„æ˜¯å¦å·²åŒ…å«è¯­è¨€å‰ç¼€
      const localeRegex = new RegExp(`^/(${supportedLanguages.join('|')})(/.*)?$`);
      const localeMatch = pathname.match(localeRegex);
      
      let locale = null;
      let basePath = pathname;
      
      if (localeMatch) {
        locale = localeMatch[1];
        basePath = localeMatch[2] || '/';
      }
      
      // ç¡®å®šå½“å‰åº”è¯¥ä½¿ç”¨çš„è¯­è¨€
      let currentLocale = defaultLocale;
      
      // 1. ä¼˜å…ˆæ£€æŸ¥ referer ä¸­çš„è¯­è¨€ï¼ˆæ¨¡æ‹Ÿ middleware çš„ referer é€»è¾‘ï¼‰
      const referer = document.referrer;
      if (referer) {
        try {
          const refererUrl = new URL(referer);
          const refererMatch = refererUrl.pathname.match(localeRegex);
          if (refererMatch) {
            currentLocale = refererMatch[1];
            console.log('Found locale from referer:', currentLocale);
          }
        } catch (e) {
          console.error('Referer parsing error:', e);
        }
      }
      
      // 2. å¦‚æœæ²¡æœ‰ä» referer è·å–åˆ°è¯­è¨€ï¼Œæ£€æŸ¥å…¶ä»–æ¥æº
      if (currentLocale === defaultLocale) {
        // æ£€æŸ¥ localStorage ä¸­çš„è¯­è¨€åå¥½ï¼ˆGitHub Pages ç‰¹æœ‰ï¼‰
        try {
          const savedLocale = localStorage.getItem('preferred-locale');
          if (savedLocale && supportedLanguages.includes(savedLocale)) {
            currentLocale = savedLocale;
            console.log('Found locale from localStorage:', currentLocale);
          }
        } catch (e) {
          console.error('localStorage error:', e);
        }
        
        // æ£€æŸ¥æµè§ˆå™¨è¯­è¨€ï¼ˆæ¨¡æ‹Ÿ accept-language å¤´ï¼‰
        if (currentLocale === defaultLocale) {
          const browserLang = navigator.language || navigator.languages?.[0];
          if (browserLang && browserLang.includes('zh')) {
            currentLocale = 'zh';
            console.log('Found locale from browser language:', currentLocale);
          }
        }
      }
      
      // å¤„ç†è¯­è¨€åˆ‡æ¢æŸ¥è¯¢å‚æ•°ï¼ˆæ¨¡æ‹Ÿ middleware çš„ switchLocale é€»è¾‘ï¼‰
      const switchLocale = urlParams.get('locale');
      if (switchLocale && supportedLanguages.includes(switchLocale)) {
        urlParams.delete('locale');
        const newSearch = urlParams.toString();
        const targetPath = `/${switchLocale}${basePath}${newSearch ? '?' + newSearch : ''}`;
        console.log('Language switch detected, redirecting to:', targetPath);
        window.location.replace(targetPath);
        return;
      }
      
      // å¤„ç†æ ¹è·¯å¾„æˆ–æ— è¯­è¨€å‰ç¼€çš„æƒ…å†µï¼ˆæ¨¡æ‹Ÿ middleware çš„ä¸»é€»è¾‘ï¼‰
      if (pathname === '/' || !locale) {
        const targetPath = `/${currentLocale}${pathname}${search}`;
        console.log('Adding locale prefix, redirecting to:', targetPath);
        window.location.replace(targetPath);
        return;
      }
      
      // æœ‰è¯­è¨€å‰ç¼€ä½†é¡µé¢ä¸å­˜åœ¨çš„æƒ…å†µ
      // åœ¨ GitHub Pages ä¸­ï¼Œè¿™é€šå¸¸æ„å‘³ç€é¡µé¢ç¡®å®ä¸å­˜åœ¨
      // æˆ‘ä»¬å¯ä»¥å°è¯•å»æ‰å¯èƒ½çš„å­è·¯å¾„ï¼Œæˆ–è€…é‡å®šå‘åˆ°è¯¥è¯­è¨€çš„é¦–é¡µ
      if (basePath !== '/') {
        // å°è¯•é‡å®šå‘åˆ°è¯¥è¯­è¨€çš„é¦–é¡µ
        const targetPath = `/${locale}/${search}`;
        console.log('Page not found with locale prefix, redirecting to locale home:', targetPath);
        window.location.replace(targetPath);
      }
    })();
  </script>
</head>
<body>
  <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: system-ui;">
    <div style="text-align: center;">
      <div style="margin-bottom: 16px;">ğŸ”„</div>
      <div>Loading...</div>
    </div>
  </div>
</body>
</html> 
